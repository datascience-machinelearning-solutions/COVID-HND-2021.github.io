---
title: "Geoestadística"
---
Visita la página Web: https://datascience-machinelearning-solutions.github.io/homepage-ho.github.io/

```{r echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(htmltools)
library(readxl)
library(leaflet)

departamento_1<-read_xlsx("C:/Users/ladylee/Desktop/Covid-HO-2021/Honduras_GIS.xlsx")

map<-leaflet(departamento_1) %>% addTiles() %>% 
     addCircles(group="Departamentos",                                                 lng = departamento_1$Longitud,lat = departamento_1$Latitud, label = paste0("<b>Departamento:<b><br>", departamento_1$Departamento, "<b><br>Infectados:<b><br>",departamento_1$Infectados,"<b><br>Muertos:<b><br>", departamento_1$Muertos,"<b><br>Recuperados:<b><br>",departamento_1$Recuperados)%>% lapply(htmltools::HTML), radius = 8,weight = 8,color = "green") 
        
map<-map %>% addProviderTiles(group ="Rutas" ,providers$OpenStreetMap)
        map<-map %>% addProviderTiles(group ="Satelite" ,providers$Esri.WorldImagery)
        map<-map %>% addProviderTiles(group ="Precipitacion" ,providers$OneMapSG.Default)
        map<-map %>% addProviderTiles(group ="Presion" ,providers$OpenStreetMap.HOT)
        
        map<-map %>% addLayersControl(baseGroups = c("Rutas", "Satelite", "Precipitacion", "Presion"),options = layersControlOptions(collapsed = TRUE,width=40,height=40)) %>% addLegend("bottomright", colors = "#03F", labels = "Fuente: SINAGER al 06/08/21 https://covid19honduras.org/ ")

map
```


```{r echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
map <- leaflet(departamento_1) %>% addTiles()   %>% 
addMarkers(clusterOptions = markerClusterOptions(),lng = departamento_1$Longitud,lat = departamento_1$Latitud,                                                popup = paste0("<b>Departamento:<b><br>", departamento_1$Departamento, "<b><br>Infectados:<b><br>",departamento_1$Infectados,"<b><br>Muertos:<b><br>", departamento_1$Muertos,"<b><br>Recuperados:<b><br>",
                                                                                                                                                              departamento_1$Recuperados)%>% lapply(htmltools::HTML)) %>% addLayersControl(baseGroups = c("Rutas", "Satelite", "Precipitacion", "Presion"),options = layersControlOptions(collapsed = TRUE,width=40,height=40)) %>% addLegend("bottomright", colors = "#03F", labels = "Fuente: SINAGER al 06/08/21 https://covid19honduras.org/ ")


map
```



```{r echo=FALSE}

library(osrm)
dist<- departamento_1 %>% dplyr::select(Departamento, Latitud, Longitud) %>% 
 dplyr::filter(Departamento == "Francisco Morazán") 
dist1<- departamento_1 %>% dplyr::select(Departamento, Latitud, Longitud) %>% 
 dplyr::filter(Departamento =="Olancho") 
dist2<- departamento_1 %>% dplyr::select(Departamento, Latitud, Longitud) %>% 
 dplyr::filter(Departamento =="Olancho" & Departamento == "Francisco Morazán") 


dist_viaje1 <- osrmRoute(src = c(dist$Departamento, dist$Latitud, dist$Longitud), 
                          dst = c(dist1$Departamento, dist1$Latitud, dist1$Longitud), 
                          returnclass = "sf", 
                          overview = "full",
                          osrm.profile = "car")
```


```{r echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

datacovid_observatorio<-fread("C:/Users/ladylee/Desktop/Shiny_r/BD Coronavirus 1jul21.csv",
                                      stringsAsFactors = TRUE )
```

Explorando datos
```{r include=FALSE }
names(datacovid_observatorio) # Nombre de las Columnas
        
```


```{r include=FALSE}
Municipios_de_HONDURAS <- st_read("C:/Users/ladylee/Desktop/FLACSO-territorialidad/ciencia-datos-geo2/division_municipal_hn", stringsAsFactors = TRUE, options="ENCODING=Latin1")

```

```{r include=FALSE}
library(dplyr)
library(stringi)
library(sf)

  MUNICIPIOS_2<- Municipios_de_HONDURAS %>% 
  dplyr::select(CONECTAR, COD_MUNI, NOMBRE, POB_2000,IDH_2002,AREA, geometry) %>% 
  dplyr::rename(DEPARTAMENTO = CONECTAR) %>%   
  dplyr::mutate(NOMBRE = toupper(stri_trans_general(NOMBRE,"Latin-ASCII"))) %>% 
  dplyr::mutate (NOMBRE = replace(NOMBRE, NOMBRE == "LAGO DE YOJOA", "NO DETERMINADO")) %>% 
  dplyr::mutate(NOMBRE = as.factor(NOMBRE))


head(MUNICIPIOS_2)

#st_write(MUNICIPIOS_2, "C:/Users/ladylee/Desktop/MUNICIPIO2.geojson")
```
``


```{r include=FALSE}

library(stringi)
 
 BASE_COVID_1<-datacovid_observatorio %>% 
   
   dplyr::rename (NOMBRE = Municipio) %>%  
   dplyr::mutate (NOMBRE = toupper(stri_trans_general(NOMBRE,"Latin-ASCII"))) %>% 
   dplyr::mutate (datacovid_observatorio,NOMBRE = replace(NOMBRE,NOMBRE == "CABAÑA", "CABANA")) %>% 
   dplyr::mutate (datacovid_observatorio,NOMBRE = replace(NOMBRE,NOMBRE == "CABAÑAs", "CABANA")) %>%
   dplyr::mutate (datacovid_observatorio,NOMBRE = replace(NOMBRE,NOMBRE == "CABANAs", "CABANA")) %>%
   dplyr::mutate (datacovid_observatorio,NOMBRE = replace(NOMBRE,NOMBRE == "NO  DETERMINADO", "NO DETERMINADO")) %>%
   dplyr::mutate (datacovid_observatorio, NOMBRE = replace(NOMBRE, NOMBRE == "NUEVA CELILAC", "NUEVO CELILAC")) %>% 
   dplyr::mutate (datacovid_observatorio, NOMBRE = as.factor(NOMBRE)) 
   
 
 head(BASE_COVID_1)
 

```


```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

BASE_COVID_2 <- BASE_COVID_1 %>% filter(`Tipo de Dato`== "MUERTE") %>% 
group_by(NOMBRE) %>% 
summarise(MUERTE= n())

BASE_COVID_3 <- BASE_COVID_1 %>% filter(`Tipo de Dato`== "CASOS") %>% 
group_by(NOMBRE) %>% 
summarise(CASOS = n())

BASE_COVID_4 <- BASE_COVID_1 %>% filter(`Tipo de Dato`== "RECUPERADO") %>% 
group_by(NOMBRE) %>% 
summarise(RECUPERADO= n())


```


```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
depa<-left_join(MUNICIPIOS_2, BASE_COVID_2, by= "NOMBRE")

depa1<-left_join(depa, BASE_COVID_3, by= "NOMBRE")
depa2<-left_join(depa1, BASE_COVID_4, by= "NOMBRE")  
depa3 <- depa2 %>%  dplyr::filter (DEPARTAMENTO != "0")
#st_write(depa3, "C:/Users/ladylee/Desktop/depa3.geojson")

```

Explorar distribución de valores
```{r }
knitr::opts_chunk$set(echo = FALSE)
hist(depa3$MUERTE, main= "Muertes por COVID", xlab="", border = "blue", color= "green")
```

Ver outliers numéricos
```{r }
knitr::opts_chunk$set(echo = FALSE)
boxplot(depa3$MUERTE ~ DEPARTAMENTO, data = depa3,  col = rainbow(ncol(depa3)))
```
Explorar distribucion espacial de variables de interes con tmap

```{r }
knitr::opts_chunk$set(echo = FALSE)
library(tmap)
qtm(depa3, fill = "MUERTE")
```

```{r }
knitr::opts_chunk$set(echo = FALSE)
tm_shape(depa3) + 
tm_fill(col="MUERTE", style="quantile", n=10, palette="-Greens", title="Muertos al 01/07/2021") +
tm_legend(outside=TRUE)
```

```{r }
knitr::opts_chunk$set(echo = FALSE)
tm_shape(depa3) + 
  tm_fill("MUERTE", style = "quantile", n = 5, palette = "Reds") +
  tm_borders(alpha = 0.1) +
  tm_layout(main.title = "Muertos al 1/07/2021", main.title.size = 0.7 ,
            legend.position = c("right", "bottom"), legend.title.size = 0.8)

```



Vecinos

Lista de vecinos (de clase nb) a partir de los poligonos con poly2nb 

poly2nb(polis, row.names = NULL, queen=TRUE,)
 
polis pueden ser sf o SpatialPolygons (sp)
row.names =  columna con el id o nombre de los poligonos
queen = True vecinos por 1 punto de borde,   False vecinos por dos o mas puntos de borde
 
```{r }
knitr::opts_chunk$set(echo = FALSE)
library(sf)
library(tmap)
library(tidyverse)
library(spdep)
w <- poly2nb(depa3, row.names = "DEPARTAMENTO")
```

Explorar los vecinos
```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#w
summary(w)
#str(w)
#card(w)
```


Mapear los vecinos

```{r }
knitr::opts_chunk$set(echo = FALSE)
plot(st_geometry(depa3), border="grey")
plot(w, coordinates(as(depa3, "Spatial")), add=TRUE, col="blue")
```


```{r include=FALSE}
wmatb <- nb2mat(w, style='B', zero.policy = TRUE)
wmatb
```

¿Cómo seria con los pesos estandarizados por fila (style='W')?

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
wmatW <- nb2mat(w, style='W', zero.policy = TRUE)
wmatW
```

Matrix de pesos en formato listw

```{r }
knitr::opts_chunk$set(echo = FALSE)
lwb <-  nb2listw(w, style='B',  zero.policy = TRUE)

print(lwb, zero.policy = TRUE)
```

Exploración de Indices de asociación/correlación espacial

Moran I Global

```{r }
knitr::opts_chunk$set(echo = FALSE)
moran.test(depa3$MUERTE, lwb, zero.policy = TRUE, na.action = na.omit)
```

Cómo se interpretan el valor de Moran I? ¿Alguno es significativo?7
